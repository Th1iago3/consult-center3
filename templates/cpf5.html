<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta - CPF</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #E6E6FA;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .container {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 15px 25px rgba(0,0,0,0.05);
            padding: 40px;
            width: 400px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }

        h2 {
            color: #333;
            margin-bottom: 30px;
        }

        .form-group {
            margin: 20px 0;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: none;
            border-bottom: 2px solid #ccc;
            background: transparent;
            color: #333;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #6C63FF;
            transform: scale(1.01);
        }

        .button {
            display: inline-block;
            background: linear-gradient(45deg, #6C63FF, #4E54C8);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .button:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .button:active {
            transform: translateY(0) scale(1);
        }

        .alert {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            animation: fadeIn 0.5s ease-in;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .alert-success { background-color: #E3FCEF; color: #155724; border-left: 5px solid #155724; }
        .alert-error { background-color: #FFEBEE; color: #721C24; border-left: 5px solid #721C24; }

        .profile-info {
            background: #F3F4FF;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: left;
        }

        .profile-info p {
            margin: 5px 0;
            color: #555;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Consulta - CPF</h2>
        <div id="messages">
            <?php 
            // Aqui começa o PHP
            $cpf = isset($_GET['cpf']) ? $_GET['cpf'] : '';
            if ($cpf) {
                $result = processar_cpf($cpf);
                echo $result;
            }
            ?>
        </div>
        <form method="GET">
            <div class="form-group">
                <input type="text" name="cpf" placeholder="Digite o CPF..." value="<?php echo htmlspecialchars($cpf); ?>" required>
            </div>
            <button type="submit" class="button">Consultar</button>
        </form>
    </div>

    <?php
    function processar_cpf($cpf) {
        $credentials = getenv('PNI_CREDENTIALS') ?: 'carlinhos.edu.10@hotmail.com:#Esp210400'; // Use variáveis de ambiente para segurança
        $credentials_base64 = base64_encode($credentials);
        $url_login = 'https://servicos-cloud.saude.gov.br/pni-bff/v1/autenticacao/tokenAcesso';
        $url_pesquisa_base = 'https://servicos-cloud.saude.gov.br/pni-bff/v1/cidadao/cpf/';
        $headers_login = [
            "Host: servicos-cloud.saude.gov.br",
            "Connection: keep-alive",
            "Content-Length: 0",
            "sec-ch-ua: \"Not.A/Brand\";v=\"8\", \"Chromium\";v=\"114\", \"Google Chrome\";v=\"114\"",
            "accept: application/json",
            "X-Authorization: Basic $credentials_base64",
            "sec-ch-ua-mobile: ?0",
            "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36",
            "sec-ch-ua-platform: Windows",
            "Origin: https://si-pni.saude.gov.br",
            "Sec-Fetch-Site: same-site",
            "Sec-Fetch-Mode: cors",
            "Sec-Fetch-Dest: empty",
            "Referer: https://si-pni.saude.gov.br/",
            "Accept-Encoding: gzip, deflate, br",
            "Accept-Language: pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7"
        ];
        $max_retries = 3; 
        $retry_delay = 5; 

        for ($i = 0; $i < $max_retries; $i++) {
            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, $url_login);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers_login);
            curl_setopt($ch, CURLOPT_POST, 1);
            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
            $response_login = curl_exec($ch);
            if ($response_login === false) {
                curl_close($ch);
                sleep($retry_delay); 
                continue;
            }
            curl_close($ch);
            $login_data = json_decode($response_login, true);
            if (isset($login_data['accessToken'])) {
                $token_acesso = $login_data['accessToken'];
                $url_pesquisa = $url_pesquisa_base . $cpf;
                $headers_pesquisa = [
                    'Host: servicos-cloud.saude.gov.br',
                    "Authorization: Bearer $token_acesso",
                    'Accept: application/json, text/plain, */*',
                    'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36',
                    'Origin: https://si-pni.saude.gov.br',
                    'Sec-Fetch-Site: same-site',
                    'Sec-Fetch-Mode: cors',
                    'Sec-Fetch-Dest: empty',
                    'Referer: https://si-pni.saude.gov.br/',
                    'Accept-Encoding: gzip, deflate, br',
                    'Accept-Language: pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7'
                ];

                for ($j = 0; $j < $max_retries; $j++) {
                    $ch = curl_init();
                    curl_setopt($ch, CURLOPT_URL, $url_pesquisa);
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers_pesquisa);
                    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
                    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
                    $response_pesquisa = curl_exec($ch);
                    if ($response_pesquisa === false) {
                        curl_close($ch);
                        sleep($retry_delay);
                        continue;
                    }
                    curl_close($ch);
                    $dados_pessoais = json_decode($response_pesquisa, true);
                    if (isset($dados_pessoais['records'])) {
                        return formatar_informacoes($dados_pessoais['records'][0]);
                    } else {
                        return "<div class='alert alert-error'>Erro na pesquisa: " . htmlspecialchars($response_pesquisa) . "</div>";
                    }
                }
                return "<div class='alert alert-error'>Falha na requisição de pesquisa após várias tentativas</div>";
            } else {
                return "<div class='alert alert-error'>Erro no login: " . htmlspecialchars($response_login) . "</div>";
            }
        }

        return "<div class='alert alert-error'>Falha na requisição de login após várias tentativas</div>";
    }

    function formatar_informacoes($dados_pessoais) {
        // Formatar a data de nascimento e calcular a idade
        $dataNascimento = isset($dados_pessoais['dataNascimento']) ? $dados_pessoais['dataNascimento'] : 'SEM INFORMAÇÃO';
        $idade = 'SEM INFORMAÇÃO';
        if ($dataNascimento != 'SEM INFORMAÇÃO') {
            try {
                $dataNascimentoObj = new DateTime($dataNascimento);
                $hoje = new DateTime();
                $idade = $hoje->diff($dataNascimentoObj)->y . " anos";
            } catch (Exception $e) {
                $idade = 'DATA INVÁLIDA';
            }
        }

        // Verificar se 'endereco' é um array antes de acessar
        $endereco = isset($dados_pessoais['endereco']) && is_array($dados_pessoais['endereco']) ? $dados_pessoais['endereco'] : [];

        // Verificar individualmente os campos do endereço
        $logradouro = isset($endereco['logradouro']) ? $endereco['logradouro'] : 'SEM INFORMAÇÃO';
        $cidade = isset($endereco['cidade']) ? $endereco['cidade'] : 'SEM INFORMAÇÃO';
        $bairro = isset($endereco['bairro']) ? $endereco['bairro'] : 'SEM INFORMAÇÃO';
        $cep = isset($endereco['cep']) ? $endereco['cep'] : 'SEM INFORMAÇÃO';

        // Construir a string com os dados formatados
        $output = "<div class='profile-info'>";
        $output .= "<p><strong>NOME:</strong> " . htmlspecialchars($dados_pessoais['nome'] ?? 'SEM INFORMAÇÃO') . "</p>";
        $output .= "<p><strong>CPF:</strong> " . htmlspecialchars($dados_pessoais['cpf'] ?? 'SEM INFORMAÇÃO') . "</p>";
        $output .= "<p><strong>NOME DA MÃE:</strong> " . htmlspecialchars($dados_pessoais['nomeMae'] ?? 'SEM INFORMAÇÃO') . "</p>";
        $output .= "<p><strong>NOME DO PAI:</strong> " . htmlspecialchars($dados_pessoais['nomePai'] ?? 'SEM INFORMAÇÃO') . "</p>";
        $output .= "<p><strong>CNS:</strong> " . htmlspecialchars($dados_pessoais['cns'] ?? 'SEM INFORMAÇÃO') . "</p>";
        $output .= "<p><strong>Nascimento:</strong> $dataNascimento ($idade)</p>";
        $output .= "<p><strong>EMAIL:</strong> " . htmlspecialchars($dados_pessoais['email'] ?? 'SEM INFORMAÇÃO') . "</p>";
        $output .= "<p><strong>Sexo:</strong> " . htmlspecialchars($dados_pessoais['sexo'] ?? 'SEM INFORMAÇÃO') . " ";
        $output .= "<strong>Cor:</strong> " . htmlspecialchars($dados_pessoais['racaCor'] ?? 'SEM INFORMAÇÃO') . " ";
        $output .= "<strong>Grau de Qualidade:</strong> " . htmlspecialchars($dados_pessoais['grauQualidade'] ?? 'SEM INFORMAÇÃO') . "</p>";

        // Endereço formatado corretamente
        $output .= "<p><strong>Endereço:</strong><br>";
        $output .= "Logradouro: " . htmlspecialchars($logradouro) . "<br>";
        $output .= "Cidade: " . htmlspecialchars($cidade) . "<br>";
        $output .= "Bairro: " . htmlspecialchars($bairro) . "<br>";
        $output .= "CEP: " . htmlspecialchars($cep) . "<br>";
        $output .= "Número: ( manutenção )</p>";

        // Dados usados
        $output .= "<p><strong>DADOS USADOS:</strong><br>";
        $output .= "CPF: " . htmlspecialchars($dados_pessoais['cpf'] ?? 'SEM INFORMAÇÃO') . "<br>";
        
        $output .= "</div>";

        return $output;
    }
    ?>
</body>
</html>
